services:
  app:
    build:
        context: ..
        dockerfile: infra/build/Dockerfile
    image: project:v0
    command: python src/main_training.py
    volumes:
      - ../data:/app/data
      - ../src:/app/src
      - ../configs:/app/configs
    depends_on:
      mlflow:
        condition: service_healthy

  mlflow:
    image: ghcr.io/mlflow/mlflow:v3.3.0rc0
    command: mlflow server --host 0.0.0.0 --port 8080
    ports:
      - "8080:8080"
    healthcheck:
      test: apt-get update -y && apt-get install -y curl && curl --fail http://localhost:8080 || exit 1
      retries: 3
      interval: 5s

  dagster:
      build:
        context: ..
        dockerfile: infra/build/Dockerfile
      image: project:v0
      container_name: dagster_ui
      command: sh -c "mkdir -p /app/dagster_home/logs &&
             dagster dev -h 0.0.0.0 -p 4242 -f src/main_training.py"
      environment:
        - APP_ENV=DOCKER
        - DAGSTER_HOME=/app/dagster_home
      ports:
        - "4242:4242"
      volumes:
        - ../data:/app/data
        - ../configs:/app/configs
        - ../src:/app/src
        - dagster_storage:/app/dagster_home
      depends_on:
        mlflow:
          condition: service_healthy

volumes:
  dagster_storage: